<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†Œì„¤ë§ - ìš°ë¦¬ë“¤ì˜ ì´ì•¼ê¸°</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body data-theme="light">

    <header>
        <div class="logo">UNFRAME</div>
        <div class="header-actions">
            <div class="search-container">
                <span class="search-icon">ğŸ”</span>
                <input type="text" placeholder="ì‘í’ˆ, ì‘ê°€ ê²€ìƒ‰">
            </div>
            <button class="theme-toggle">ğŸŒ™</button>
            <button class="create-btn">ì†Œì…œë§ ë§Œë“¤ê¸°</button>
        </div>
    </header>

    <main>
        <section class="hero">
            <div class="hero-content">
                <h1 class="hero-sentence">"ëª¨ë“  ìœ„ëŒ€í•œ ê¿ˆì€ ê¿ˆê¾¸ëŠ” ì‚¬ëŒìœ¼ë¡œë¶€í„° ì‹œì‘ëœë‹¤."</h1>
                <a href="#feed" class="hero-cta">ì´ì•¼ê¸° ë‘˜ëŸ¬ë³´ê¸°</a>
            </div>
        </section>

        <section class="introduction-section">
            <h2>UNFRAME ì†Œì…œë§ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</h2>
            <p>
                UNFRAMEì€ ë‹¨ìˆœí•œ ë…ì„œ ëª¨ì„ì„ ë„˜ì–´, ì·¨í–¥ì´ ë¹„ìŠ·í•œ ì‚¬ëŒë“¤ì´ ë§Œë‚˜ í•¨ê»˜ ì´ì•¼ê¸°ë¥¼ ë°œê²¬í•˜ê³  êµë¥˜í•˜ëŠ” 'ì†Œì…œë§' ì»¤ë®¤ë‹ˆí‹°ì…ë‹ˆë‹¤.<br>
                ë‹¤ì±„ë¡œìš´ ì¥ë¥´ì˜ ê¸€ì„ í†µí•´ ìƒˆë¡œìš´ ì¸ì—°ì„ ë§Œë‚˜ê³ , ë‚˜ì˜ ê´€ì‹¬ì‚¬ë¥¼ ë„“í˜€ë³´ì„¸ìš”. UNFRAMEì€ ì–´ìƒ‰í•œ ë§Œë‚¨ì´ ì•„ë‹Œ, ìì—°ìŠ¤ëŸ¬ìš´ ì¦ê±°ì›€ ì†ì—ì„œ ë‹¹ì‹ ì˜ ì‚¶ì´ ë”ìš± í’ìš”ë¡œì›Œì§€ë„ë¡ ê³ì—ì„œ í•¨ê»˜í•˜ê² ìŠµë‹ˆë‹¤.
            </p>
        </section>

        <section class="feed-container" id="feed">
            <div class="card-grid" id="card-grid">
                <!-- Cards will be injected here by JavaScript -->
            </div>
            <div id="loader">
                <span>Loading...</span>
            </div>
        </section>
    </main>

    <div class="modal-overlay" id="application-modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2>ìƒˆë¡œìš´ ì†Œì…œë§ ë§Œë“¤ê¸°</h2>
            <form id="application-form">
                <div class="form-group">
                    <label for="ring-image">ëŒ€í‘œ ì´ë¯¸ì§€</label>
                    <div id="image-dropzone" class="image-dropzone">
                        <div class="image-dropzone-text">
                            ì‚¬ì§„ì„ ëŒì–´ë‹¤ ë†“ê±°ë‚˜ í´ë¦­í•´ì„œ ì„ íƒí•˜ì„¸ìš”
                        </div>
                        <img id="image-preview" class="image-preview" alt="" />
                    </div>
                    <input type="file" id="ring-image" name="ring-image" accept="image/*" capture="environment">
                </div>
                <div class="hp-field" aria-hidden="true">
                    <label for="hp-field-create">Leave this field empty</label>
                    <input type="text" id="hp-field-create" name="company">
                </div>
                <div class="form-group">
                    <label for="ring-name">ì†Œì…œë§ ì´ë¦„</label>
                    <input type="text" id="ring-name" name="ring-name" required>
                </div>
                <div class="form-group">
                    <label for="leader-name">ë¦¬ë” ì´ë¦„</label>
                    <input type="text" id="leader-name" name="leader-name" required>
                </div>
                <div class="form-group">
                    <label for="description">ëª¨ì„ ì†Œê°œ</label>
                    <textarea id="description" name="description" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label for="genre">ì£¼ì œ / ì¥ë¥´</label>
                    <input type="text" id="genre" name="genre" placeholder="ì˜ˆ: SF, ê³ ì „, ì‹œ, ì›¹ì†Œì„¤ ë“±" required>
                </div>
                <div class="form-group form-group-half">
                    <label for="max-members">ëª¨ì§‘ ì¸ì›</label>
                    <input type="number" id="max-members" name="max-members" min="2" max="20" value="5">
                </div>
                <div class="form-group form-group-half">
                    <label for="contact-info">ì—°ë½ì²˜</label>
                    <input type="text" id="contact-info" name="contact-info" placeholder="ì¹´ì¹´ì˜¤í†¡ ì˜¤í”ˆì±„íŒ… ë§í¬ ë“±" required>
                </div>
                <button type="submit" class="submit-btn">ë§Œë“¤ê¸°</button>
            </form>
        </div>
    </div>

    <!-- Modal for Joining a Ring -->
    <div class="modal-overlay" id="join-modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2 id="join-modal-title">"" ì†Œì…œë§ì— ì°¸ì—¬ ì‹ ì²­</h2>
            <form id="join-form">
                <div class="hp-field" aria-hidden="true">
                    <label for="hp-field-join">Leave this field empty</label>
                    <input type="text" id="hp-field-join" name="company">
                </div>
                <input type="hidden" id="join-ring-title" name="join-ring-title">
                <div class="form-group">
                    <label for="join-name">ì‹ ì²­ì ì´ë¦„</label>
                    <input type="text" id="join-name" name="join-name" required>
                </div>
                <div class="form-group">
                    <label for="join-contact">ì—°ë½ì²˜</label>
                    <input type="text" id="join-contact" name="join-contact" placeholder="íšŒì‹ ë°›ì„ ì—°ë½ì²˜ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”" required>
                </div>
                <div class="form-group">
                    <label for="join-message">ëª¨ì„ì¥ì—ê²Œ ì „í•˜ëŠ” ë©”ì‹œì§€</label>
                    <textarea id="join-message" name="join-message" rows="4" required></textarea>
                </div>
                <button type="submit" class="submit-btn">ì°¸ì—¬ ì‹ ì²­í•˜ê¸°</button>
            </form>
        </div>
    </div>

    <div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const themeToggle = document.querySelector('.theme-toggle');
            const cardGrid = document.getElementById('card-grid');
            const loader = document.getElementById('loader');
            const heroCta = document.querySelector('.hero-cta');
            const createBtn = document.querySelector('.create-btn');
            const closeButtons = document.querySelectorAll('.modal-close');
            const searchInput = document.querySelector('.search-container input');
            const imageInput = document.getElementById('ring-image');
            const imageDropzone = document.getElementById('image-dropzone');
            const imagePreview = document.getElementById('image-preview');
            let imageDataUrl = '';

            // --- 1. Theme Toggler ---
            const currentTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', currentTheme);
            themeToggle.textContent = currentTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';

            themeToggle.addEventListener('click', () => {
                let newTheme = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
                document.body.setAttribute('data-theme', newTheme);
                themeToggle.textContent = newTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
                localStorage.setItem('theme', newTheme);
            });
            
            // --- 2. Hero CTA Scroll ---
            heroCta.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelector('#feed').scrollIntoView({
                    behavior: 'smooth'
                });
            });

            // --- 3. Generic Modal Control ---
            const openModal = (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.classList.add('modal-open');
                }
            };

            const closeModal = (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                }
            };

            // Event listener for "Create" button
            createBtn.addEventListener('click', () => openModal('application-modal'));

            // Event listeners for all close buttons
            closeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const modal = btn.closest('.modal-overlay');
                    closeModal(modal.id);
                });
            });

            // Event listener for clicking modal overlay
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    closeModal(e.target.id);
                }
            });

            // --- 4. Form Submission Handlers ---
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxIF9eGDGkAyAebnOCL_Q2MxtNEyOdod0zrFjiRpR1sUxjhn_44X-Q-VeZZAvnDqLoADA/exec';
            const toastContainer = document.getElementById('toast-container');

            const showToast = (message, type = 'success') => {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.style.animation = 'toast-out 0.25s ease forwards';
                }, 2200);

                setTimeout(() => {
                    toast.remove();
                }, 2500);
            };

            const setImagePreview = (dataUrl) => {
                if (!dataUrl) {
                    imagePreview.style.display = 'none';
                    imagePreview.src = '';
                    return;
                }
                imagePreview.src = dataUrl;
                imagePreview.style.display = 'block';
            };

            const loadImageFile = (file) => {
                if (!file) return;
                if (!file.type.startsWith('image/')) {
                    showToast('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆì–´ìš”.', 'error');
                    return;
                }
                const reader = new FileReader();
                reader.onload = () => {
                    imageDataUrl = reader.result;
                    setImagePreview(imageDataUrl);
                };
                reader.readAsDataURL(file);
            };

            imageDropzone.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', (e) => loadImageFile(e.target.files[0]));
            imageDropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                imageDropzone.classList.add('dragover');
            });
            imageDropzone.addEventListener('dragleave', () => {
                imageDropzone.classList.remove('dragover');
            });
            imageDropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                imageDropzone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                loadImageFile(file);
            });

            const normalizeContact = (raw) => {
                if (/[A-Za-z]/.test(raw)) {
                    return { ok: false, message: 'ì—°ë½ì²˜ëŠ” ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.' };
                }
                const digits = raw.replace(/\D/g, '');
                if (!digits.startsWith('010') || digits.length !== 11) {
                    return { ok: false, message: 'ì—°ë½ì²˜ëŠ” 010ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” 11ìë¦¬ ë²ˆí˜¸ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.' };
                }
                const formatted = `${digits.slice(0, 3)}-${digits.slice(3, 7)}-${digits.slice(7)}`;
                return { ok: true, value: formatted };
            };

            const formatContactInput = (inputEl) => {
                const raw = inputEl.value;
                if (/[A-Za-z]/.test(raw)) {
                    showToast('ì—°ë½ì²˜ì—ëŠ” ë¬¸ìë¥¼ ì…ë ¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                }
                const digits = raw.replace(/\D/g, '').slice(0, 11);
                if (digits.length === 11 && digits.startsWith('010')) {
                    inputEl.value = `${digits.slice(0, 3)}-${digits.slice(3, 7)}-${digits.slice(7)}`;
                } else {
                    inputEl.value = digits;
                }
            };
            const createContactInput = document.getElementById('contact-info');
            createContactInput.addEventListener('blur', () => formatContactInput(createContactInput));
            createContactInput.addEventListener('input', () => formatContactInput(createContactInput));

            document.getElementById('application-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (document.getElementById('hp-field-create').value) {
                    showToast('ì „ì†¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                const ringName = document.getElementById('ring-name').value.trim();
                const leaderName = document.getElementById('leader-name').value.trim();
                const description = document.getElementById('description').value.trim();
                const genre = document.getElementById('genre').value.trim();
                const maxMembers = document.getElementById('max-members').value.trim();
                const contactInfoRaw = document.getElementById('contact-info').value.trim();
                const imageUrl = imageDataUrl;
                const contactCheck = normalizeContact(contactInfoRaw);
                if (!contactCheck.ok) {
                    showToast(contactCheck.message, 'error');
                    return;
                }
                const contactInfo = contactCheck.value;

                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'ì „ì†¡ ì¤‘...';

                try {
                    const payload = new URLSearchParams();
                    // Spreadsheet column order for create submissions
                    [
                        ['action', 'create'],
                        ['ringName', ringName],
                        ['leaderName', leaderName],
                        ['description', description],
                        ['genre', genre],
                        ['maxMembers', maxMembers],
                        ['contactInfo', contactInfo],
                        ['imageUrl', imageUrl]
                    ].forEach(([key, value]) => payload.append(key, value));

                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
                        },
                        body: payload
                    });

                    rings.unshift({
                        title: ringName,
                        author: leaderName,
                        excerpt: description,
                        genre,
                        maxMembers,
                        contactInfo,
                        imageUrl
                    });
                    renderCards();

                    showToast('ì†Œì…œë§ ë§Œë“¤ê¸°ê°€ ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    closeModal('application-modal');
                    e.target.reset();
                    imageDataUrl = '';
                    setImagePreview('');
                } catch (error) {
                    console.error(error);
                    showToast('ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                }
            });

            const joinContactInput = document.getElementById('join-contact');
            joinContactInput.addEventListener('blur', () => formatContactInput(joinContactInput));
            joinContactInput.addEventListener('input', () => formatContactInput(joinContactInput));

            document.getElementById('join-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (document.getElementById('hp-field-join').value) {
                    showToast('ì „ì†¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                const name = document.getElementById('join-name').value.trim();
                const contactRaw = document.getElementById('join-contact').value.trim();
                const message = document.getElementById('join-message').value.trim();
                const ringTitle = document.getElementById('join-ring-title').value.trim();

                const contactCheck = normalizeContact(contactRaw);
                if (!contactCheck.ok) {
                    showToast(contactCheck.message, 'error');
                    return;
                }
                const contact = contactCheck.value;

                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'ì „ì†¡ ì¤‘...';

                try {
                    const payload = new URLSearchParams();
                    // Spreadsheet column order for join submissions
                    [
                        ['action', 'join'],
                        ['ringTitle', ringTitle],
                        ['name', name],
                        ['contact', contact],
                        ['message', message]
                    ].forEach(([key, value]) => payload.append(key, value));

                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
                        },
                        body: payload
                    });

                    const targetBtn = document.querySelector(`.join-ring-btn[data-ring-name="${CSS.escape(ringTitle)}"]`);
                    if (targetBtn) {
                        targetBtn.textContent = 'ì‹ ì²­ ì™„ë£Œ';
                        targetBtn.disabled = true;
                    }

                    showToast('ì°¸ì—¬ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    closeModal('join-modal');
                    e.target.reset();
                } catch (error) {
                    console.error(error);
                    showToast('ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                }
            });

            // --- 5. Event Delegation for Join Buttons ---
            cardGrid.addEventListener('click', (e) => {
                if (e.target.classList.contains('join-ring-btn')) {
                    const ringName = e.target.dataset.ringName;
                    document.getElementById('join-modal-title').textContent = `"${ringName}" ì†Œì…œë§ì— ì°¸ì—¬ ì‹ ì²­`;
                    document.getElementById('join-ring-title').value = ringName;
                    openModal('join-modal');
                }
            });

            // --- 6. Cards ---
            const rings = [];
            const createCardFromData = (data) => {
                const card = document.createElement('div');
                card.classList.add('card');
                
                const imageUrl = data.imageUrl
                    ? data.imageUrl
                    : `https://picsum.photos/id/${Math.floor(Math.random() * 1000)}/400/300`;

                card.innerHTML = `
                    <div class="card-image" style="background-image: url('${imageUrl}')"></div>
                    <div class="card-content">
                        <h3 class="card-title">${data.title}</h3>
                        <p class="card-author">${data.author}</p>
                        <p class="card-excerpt">${data.excerpt}</p>
                    </div>
                    <div class="card-footer">
                        <button class="join-ring-btn" data-ring-name="${data.title}">ì°¸ì—¬í•˜ê¸°</button>
                    </div>
                `;
                cardGrid.appendChild(card);
            };

            const renderEmptyState = () => {
                cardGrid.innerHTML = `
                    <div class="card">
                        <div class="card-content">
                            <h3 class="card-title">ì•„ì§ ë“±ë¡ëœ ì†Œì…œë§ì´ ì—†ì–´ìš”</h3>
                            <p class="card-excerpt">ìƒë‹¨ì˜ â€œì†Œì…œë§ ë§Œë“¤ê¸°â€ë¡œ ì²« ëª¨ì„ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”.</p>
                        </div>
                    </div>
                `;
            };

            const renderCards = () => {
                loader.style.display = 'none';
                cardGrid.innerHTML = '';
                if (!rings.length) {
                    renderEmptyState();
                    return;
                }
                rings.forEach(createCardFromData);
            };

            renderCards();

            // --- 7. Search ---
            const normalizeCompact = (text) => {
                return text
                    .toLowerCase()
                    .replace(/\s+/g, '')
                    .replace(/[^\wê°€-í£]/g, '');
            };

            const tokenize = (text) => {
                return text
                    .toLowerCase()
                    .replace(/[^\wê°€-í£\s]/g, ' ')
                    .split(/\s+/)
                    .filter(Boolean);
            };

            const levenshtein = (a, b) => {
                const m = a.length;
                const n = b.length;
                if (m === 0) return n;
                if (n === 0) return m;
                const dp = Array.from({ length: m + 1 }, () => new Array(n + 1).fill(0));
                for (let i = 0; i <= m; i++) dp[i][0] = i;
                for (let j = 0; j <= n; j++) dp[0][j] = j;
                for (let i = 1; i <= m; i++) {
                    for (let j = 1; j <= n; j++) {
                        const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                        dp[i][j] = Math.min(
                            dp[i - 1][j] + 1,
                            dp[i][j - 1] + 1,
                            dp[i - 1][j - 1] + cost
                        );
                    }
                }
                return dp[m][n];
            };

            const isFuzzyMatch = (item, keyword) => {
                const compactKeyword = normalizeCompact(keyword);
                const fields = [item.title, item.author, item.excerpt];
                const compactFields = fields.map(normalizeCompact).join(' ');

                if (compactFields.includes(compactKeyword)) return true;

                const tokens = fields.flatMap(tokenize);
                const threshold = compactKeyword.length <= 4 ? 1 : compactKeyword.length <= 8 ? 2 : 3;
                return tokens.some((token) => levenshtein(token, compactKeyword) <= threshold);
            };

            const renderSearchResults = (term) => {
                const keyword = term.trim().toLowerCase();
                cardGrid.innerHTML = '';

                if (!keyword) {
                    renderCards();
                    return;
                }

                const results = rings.filter((item) => isFuzzyMatch(item, keyword));

                if (!results.length) {
                    const empty = document.createElement('div');
                    empty.className = 'card';
                    empty.innerHTML = `
                        <div class="card-content">
                            <h3 class="card-title">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                            <p class="card-excerpt">ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</p>
                        </div>
                    `;
                    cardGrid.appendChild(empty);
                    return;
                }

                results.forEach(createCardFromData);
            };

            searchInput.addEventListener('input', (e) => {
                renderSearchResults(e.target.value);
            });
        });
    </script>
</body>
</html>
